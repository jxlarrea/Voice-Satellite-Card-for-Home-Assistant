(()=>{"use strict";const t="IDLE",e="WAKE_WORD_DETECTED",i="STT",r="INTENT",n="TTS",s={start_listening_on_load:!0,wake_word_switch:"",state_entity:"",pipeline_id:"",pipeline_timeout:60,pipeline_idle_timeout:300,chime_on_wake_word:!0,chime_on_request_sent:!0,chime_volume:100,tts_volume:100,tts_target:"",continue_conversation:!0,double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,show_transcription:!0,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,streaming_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0};function o(t){var e=t.split(",").map(function(t){return t.trim()});return e.length>1&&e[0]!==e[e.length-1]&&e.push(e[0]),"linear-gradient(90deg, "+e.join(", ")+")"}class a{constructor(){this._debug=!1}set debug(t){this._debug=!!t}log(t,e,i){this._debug&&(void 0!==i?console.log("[VS]["+t+"] "+e,i):console.log("[VS]["+t+"] "+e))}error(t,e,i){void 0!==i?console.error("[VS]["+t+"] "+e,i):console.error("[VS]["+t+"] "+e)}}class l{constructor(t){this._card=t,this._log=t.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get audioContext(){return this._audioContext}get isStreaming(){return!!this._sendInterval}async startMicrophone(){await this._ensureAudioContextRunning();var t=this._card.config;this._log.log("mic","AudioContext state="+this._audioContext.state+" sampleRate="+this._audioContext.sampleRate);var e={sampleRate:16e3,channelCount:1,echoCancellation:t.echo_cancellation,noiseSuppression:t.noise_suppression,autoGainControl:t.auto_gain_control};if(t.voice_isolation&&(e.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),t.debug){var i=this._mediaStream.getAudioTracks();if(this._log.log("mic","Got media stream with "+i.length+" audio track(s)"),i.length>0){var r=i[0].getSettings();this._log.log("mic","Track settings: "+JSON.stringify(r))}}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic","Actual sample rate: "+this._actualSampleRate);try{await this._setupAudioWorklet(this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(t){this._log.log("mic","AudioWorklet unavailable ("+t.message+"), using ScriptProcessor"),this._setupScriptProcessor(this._sourceNode),this._log.log("mic","Audio capture via ScriptProcessor")}}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(function(t){t.stop()}),this._mediaStream=null),this._audioBuffer=[]}startSending(t){var e=this;this.stopSending(),this._sendInterval=setInterval(function(){e._sendAudioBuffer(t())},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!1})}resume(){this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!0})}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(t){this._log.error("mic","Failed to resume AudioContext on click: "+t)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error("AudioContext failed to start: "+this._audioContext.state)}async _setupAudioWorklet(t){var e=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(e);await this._audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),this._workletNode=new AudioWorkletNode(this._audioContext,"voice-satellite-processor");var r=this;this._workletNode.port.onmessage=function(t){r._audioBuffer.push(new Float32Array(t.data))},t.connect(this._workletNode),this._workletNode.connect(this._audioContext.destination)}_setupScriptProcessor(t){this._scriptProcessor=this._audioContext.createScriptProcessor(2048,1,1);var e=this;this._scriptProcessor.onaudioprocess=function(t){var i=t.inputBuffer.getChannelData(0);e._audioBuffer.push(new Float32Array(i))},t.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)}_sendAudioBuffer(t){if(null!=t&&0!==this._audioBuffer.length){for(var e=0,i=0;i<this._audioBuffer.length;i++)e+=this._audioBuffer[i].length;var r=new Float32Array(e),n=0;for(i=0;i<this._audioBuffer.length;i++)r.set(this._audioBuffer[i],n),n+=this._audioBuffer[i].length;this._audioBuffer=[],16e3!==this._actualSampleRate&&(r=this._resample(r,this._actualSampleRate,16e3));var s=this._floatTo16BitPCM(r);this._sendBinaryAudio(s,t)}}_resample(t,e,i){if(e===i)return t;for(var r=e/i,n=Math.round(t.length/r),s=new Float32Array(n),o=0;o<n;o++){var a=o*r,l=Math.floor(a),c=Math.min(l+1,t.length-1),d=a-l;s[o]=t[l]*(1-d)+t[c]*d}return s}_floatTo16BitPCM(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++){var r=Math.max(-1,Math.min(1,t[i]));e[i]=r<0?32768*r:32767*r}return e}_sendBinaryAudio(t,e){var i=this._card.connection;if(i&&i.socket&&i.socket.readyState===WebSocket.OPEN){var r=new Uint8Array(1+t.byteLength);r[0]=e,r.set(new Uint8Array(t.buffer),1),i.socket.send(r.buffer)}}}class c{constructor(t){this._card=t,this._log=t.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(t){this._streamingUrl=t}play(t){var e=this,i=this._card.config,r=this._buildUrl(t);if(this._playing=!0,i.tts_target&&"browser"!==i.tts_target)this._playRemote(r);else{var n=new Audio;n.volume=i.tts_volume/100,n.onended=function(){e._log.log("tts","Playback complete"),e._onComplete()},n.onerror=function(t){e._log.error("tts","Playback error: "+t),e._log.error("tts","URL: "+r),e._onComplete()},n.src=r,n.play().catch(function(t){e._log.error("tts","play() failed: "+t),e._onComplete()}),this._currentAudio=n}}stop(){this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null);var t=this._card.config;if(t.tts_target&&"browser"!==t.tts_target&&this._card.hass){var e=this;this._card.hass.callService("media_player","media_stop",{entity_id:t.tts_target}).catch(function(t){e._log.error("tts","Remote stop failed: "+t)})}}resetStreamingUrl(){this._streamingUrl=null}storeStreamingUrl(t){if(this._streamingUrl=null,t.tts_output&&t.tts_output.url&&t.tts_output.stream_response){var e=t.tts_output.url;this._streamingUrl=e.startsWith("http")?e:window.location.origin+e,this._log.log("tts","Streaming TTS URL available: "+this._streamingUrl)}}playChime(t){try{var e=new(window.AudioContext||window.webkitAudioContext),i=e.createOscillator(),r=e.createGain();i.connect(r),r.connect(e.destination);var n=this._card.config.chime_volume/100*.5;"wake"===t?(i.type="sine",r.gain.setValueAtTime(n,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.25),i.frequency.setValueAtTime(523,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.frequency.setValueAtTime(784,e.currentTime+.16),i.start(),i.stop(e.currentTime+.25)):"error"===t?(i.type="square",r.gain.setValueAtTime(.3*n,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),i.frequency.setValueAtTime(300,e.currentTime),i.frequency.setValueAtTime(200,e.currentTime+.08),i.start(),i.stop(e.currentTime+.15)):(i.type="sine",r.gain.setValueAtTime(n,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),i.frequency.setValueAtTime(784,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.start(),i.stop(e.currentTime+.25)),setTimeout(function(){e.close()},500)}catch(t){this._log.error("tts","Chime error: "+t)}}_playRemote(t){var e=this,i=this._card.config.tts_target;this._log.log("tts","Playing on remote: "+i+" URL: "+t),this._card.hass.callService("media_player","play_media",{entity_id:i,media_content_id:t,media_content_type:"music"}).catch(function(t){e._log.error("tts","Remote play failed: "+t)}),this._endTimer=setTimeout(function(){e._endTimer=null,e._onComplete()},2e3)}_onComplete(){this._log.log("tts","Complete — cleaning up UI"),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.onTTSComplete()}_buildUrl(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;var e=window.location.origin;return t.startsWith("/")||(t="/"+t),e+t}}class d{constructor(t){this._card=t,this._log=t.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._idleTimeoutId=null,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1}get binaryHandlerId(){return this._binaryHandlerId}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}get shouldContinue(){return this._shouldContinue}get continueConversationId(){return this._continueConversationId}get isStreaming(){return this._isStreaming}async start(t){var e=this,i=t||{},r=this._card.connection;if(!r)throw new Error("No Home Assistant connection available");var n=await r.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._log.log("pipeline","Available: "+n.pipelines.map(function(t){return t.name+" ("+t.id+")"+(t.preferred?" [preferred]":"")}).join(", "));var s=this._card.config,o=s.pipeline_id;if(!o){var a=n.pipelines.find(function(t){return t.preferred});o=a?a.id:n.pipelines[0].id}this._log.log("pipeline","Starting pipeline: "+o);var l=i.start_stage||"wake_word",c={type:"assist_pipeline/run",start_stage:l,end_stage:"tts",input:{sample_rate:16e3,timeout:"wake_word"===l?0:void 0},pipeline:o,timeout:s.pipeline_timeout};i.conversation_id&&(c.conversation_id=i.conversation_id),void 0===c.input.timeout&&delete c.input.timeout,this._log.log("pipeline","Run config: "+JSON.stringify(c)),this._unsubscribe=await r.subscribeMessage(function(t){e._card.onPipelineMessage(t)},c),this._log.log("pipeline","Subscribed, waiting for run-start..."),this._card.audio.startSending(function(){return e._binaryHandlerId}),this._isStreaming=!0,this._startIdleTimeout()}async stop(){if(this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._unsubscribe){try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}this._clearIdleTimeout()}restart(t){var e=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._clearIdleTimeout(),this.stop().then(function(){e._restartTimeout=setTimeout(function(){e._restartTimeout=null,e._isRestarting=!1,e.start().catch(function(t){e._log.error("pipeline","Restart failed: "+t),e._serviceUnavailable||(e._card.ui.showErrorBar(),e._serviceUnavailable=!0),e.restart(e._calculateRetryDelay())})},t||0)}))}restartContinue(t){var e=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._clearIdleTimeout(),this.stop().then(function(){e._isRestarting=!1,e._continueMode=!0,e.start({start_stage:"stt",conversation_id:t}).catch(function(t){e._log.error("pipeline","Continue conversation failed: "+t),e._card.chat.clear(),e._card.ui.hideBlurOverlay(),e.restart(0)})}))}handleRunStart(t){if(this._binaryHandlerId=t.runner_data.stt_binary_handler_id,this._resetIdleTimeout(),this._card.tts.storeStreamingUrl(t),this._continueMode)return this._continueMode=!1,this._card.setState(i),this._log.log("pipeline","Running (continue conversation) — binary handler ID: "+this._binaryHandlerId),void this._log.log("pipeline","Listening for speech...");this._card.setState("LISTENING"),this._log.log("pipeline","Running — binary handler ID: "+this._binaryHandlerId),this._log.log("pipeline","Listening for wake word...")}handleWakeWordStart(){if(this._serviceUnavailable){var t=this;this._recoveryTimeout&&clearTimeout(this._recoveryTimeout),this._recoveryTimeout=setTimeout(function(){t._serviceUnavailable&&(t._log.log("recovery","Wake word service recovered"),t._serviceUnavailable=!1,t._retryCount=0,t._card.ui.clearErrorBar(),t._card.ui.hideBar())},2e3)}}handleWakeWordEnd(t){var i=t.wake_word_output;if(!i||0===Object.keys(i).length)return this._log.error("error","Wake word service unavailable (empty wake_word_output)"),this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._binaryHandlerId=null,this._card.ui.showErrorBar(),this._serviceUnavailable=!0,void this.restart(this._calculateRetryDelay());this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._serviceUnavailable=!1,this._retryCount=0,this._card.ui.clearErrorBar();var r=this._card.tts;r.isPlaying&&(r.stop(),this._pendingRunEnd=!1),this._intentErrorBarTimeout&&(clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=null),this._card.chat.clear(),this._shouldContinue=!1,this._continueConversationId=null,this._card.setState(e),this._resetIdleTimeout(),this._card.config.chime_on_wake_word&&r.playChime("wake"),this._card.turnOffWakeWordSwitch(),this._card.ui.showBlurOverlay()}handleSttEnd(t){var e=t.stt_output?t.stt_output.text:"";e&&this._card.chat.showTranscription(e)}handleIntentProgress(t){var e=this._card.tts;if(t.tts_start_streaming&&e.streamingUrl&&!e.isPlaying&&(this._log.log("tts","Streaming TTS started — playing early"),this._card.setState(n),e.play(e.streamingUrl),e.streamingUrl=null),t.chat_log_delta){var i=t.chat_log_delta.content;if("string"==typeof i){var r=this._card.chat;r.streamedResponse=(r.streamedResponse||"")+i,r.updateResponse(r.streamedResponse)}}}handleIntentEnd(t){var e=null;try{e=t.intent_output.response.response_type}catch(t){}if("error"===e){var i=this._extractResponseText(t)||"An error occurred";this._log.error("error","Intent error: "+i),this._card.ui.showErrorBar(),this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._suppressTTS=!0;var r=this;return this._intentErrorBarTimeout&&clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=setTimeout(function(){r._intentErrorBarTimeout=null,r._card.ui.clearErrorBar(),r._card.ui.hideBar()},3e3),void(this._card.chat.streamedResponse="")}var n=this._extractResponseText(t);if(n&&this._card.chat.showResponse(n),this._shouldContinue=!1,this._continueConversationId=null,this._card.config.continue_conversation)try{!0===t.intent_output.continue_conversation&&(this._shouldContinue=!0,this._continueConversationId=t.intent_output.conversation_id||null,this._log.log("pipeline","Continue conversation requested — id: "+this._continueConversationId))}catch(t){}this._card.chat.streamedResponse="",this._card.chat.streamEl=null}handleTtsEnd(t){if(this._suppressTTS)return this._suppressTTS=!1,this._log.log("tts","TTS suppressed (intent error)"),void this.restart(0);var e=this._card.tts;if(e.isPlaying)return this._log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void this.restart(0);var i=t.tts_output?t.tts_output.url||t.tts_output.url_path:null;i&&e.play(i),this.restart(0)}handleRunEnd(){if(this._log.log("pipeline","Run ended"),this._binaryHandlerId=null,!this._isRestarting)return this._serviceUnavailable?(this._log.log("ui","Error recovery handling restart"),void this._card.ui.hideBlurOverlay()):this._card.tts.isPlaying?(this._log.log("ui","TTS playing — deferring cleanup"),void(this._pendingRunEnd=!0)):void this._finishRunEnd();this._log.log("pipeline","Restart already in progress — skipping run-end restart")}handleError(s){var o=s.code||"",a=s.message||"";if(this._log.log("error",o+" — "+a),-1===["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"].indexOf(o)){this._log.error("error","Unexpected: "+o+" — "+a);var l=-1!==[e,i,r,n].indexOf(this._card.currentState);this._binaryHandlerId=null,l&&this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._card.ui.showErrorBar(),this._serviceUnavailable=!0,this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this.restart(this._calculateRetryDelay())}else{if(this._log.log("pipeline","Expected error: "+o+" — restarting"),-1!==[e,i,r,n].indexOf(this._card.currentState)){this._log.log("ui","Cleaning up interaction UI after expected error"),this._card.setState(t),this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._shouldContinue=!1,this._continueConversationId=null;var c=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;this._card.config.chime_on_request_sent&&!c&&this._card.tts.playChime("done")}this.restart(0)}}finishPendingRunEnd(){this._pendingRunEnd&&this._finishRunEnd()}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}_finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._card.setState(t),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}_calculateRetryDelay(){this._retryCount++;var t=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline","Retry in "+t+"ms (attempt #"+this._retryCount+")"),t}_startIdleTimeout(){var t=this;this._clearIdleTimeout(),this._card.config.pipeline_idle_timeout<=0||(this._idleTimeoutId=setTimeout(function(){return-1!==[e,i,r,n].indexOf(t._card.currentState)?(t._log.log("pipeline","Idle timeout fired but interaction in progress — deferring"),void t._resetIdleTimeout()):t._card.tts.isPlaying?(t._log.log("pipeline","Idle timeout fired but TTS playing — deferring"),void t._resetIdleTimeout()):(t._log.log("pipeline","Idle timeout — restarting"),void t.restart(0))},1e3*this._card.config.pipeline_idle_timeout))}_clearIdleTimeout(){this._idleTimeoutId&&(clearTimeout(this._idleTimeoutId),this._idleTimeoutId=null)}_resetIdleTimeout(){this._startIdleTimeout()}_extractResponseText(t){try{var e=t.intent_output.response.speech.plain.speech;if(e)return e}catch(t){}try{if(t.intent_output.response.speech.speech)return t.intent_output.response.speech.speech}catch(t){}try{if(t.intent_output.response.plain)return t.intent_output.response.plain}catch(t){}try{if("string"==typeof t.intent_output.response)return t.intent_output.response}catch(t){}return this._log.log("error","Could not extract response text"),null}}class _{constructor(t){this._card=t,this._log=t.logger,this._globalUI=null,this._pendingStartButtonReason=void 0}get element(){return this._globalUI}ensureGlobalUI(){if(document.getElementById("voice-satellite-ui"))return this._globalUI=document.getElementById("voice-satellite-ui"),void this._flushPendingStartButton();var t=document.createElement("div");t.id="voice-satellite-ui",t.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(t),this._globalUI=t,this._injectGlobalStyles(),this.applyStyles();var e=this;t.querySelector(".vs-start-btn").addEventListener("click",function(){e._card.onStartClick()});var i=t.querySelector(".vs-start-btn");i.classList.add("visible"),i.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(this._globalUI){var t=this._card.config,e=this._globalUI.querySelector(".vs-rainbow-bar");e.style.height=t.bar_height+"px",e.style["top"===t.bar_position?"top":"bottom"]="0",e.style["top"===t.bar_position?"bottom":"top"]="auto",e.style.background=o(t.bar_gradient),e.style.backgroundSize="200% 100%";var i=this._globalUI.querySelector(".vs-blur-overlay");t.background_blur?(i.style.backdropFilter="blur("+t.background_blur_intensity+"px)",i.style.webkitBackdropFilter="blur("+t.background_blur_intensity+"px)"):(i.style.backdropFilter="none",i.style.webkitBackdropFilter="none");var r=t.bar_height||6,n=this._globalUI.querySelector(".vs-chat-container");"bottom"===t.bar_position?(n.style.bottom=r+12+"px",n.style.top="auto"):(n.style.bottom="12px",n.style.top="auto")}}updateForState(t,e,i){if(this._globalUI){var r={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[t];if(r&&(!e||r.barVisible)&&(!i||r.barVisible)){var n=this._globalUI.querySelector(".vs-rainbow-bar");r.barVisible?(n.classList.contains("error-mode")&&this.clearErrorBar(),n.classList.add("visible"),n.classList.remove("connecting","listening","processing","speaking"),r.animation&&n.classList.add(r.animation)):(n.classList.contains("error-mode")&&this.clearErrorBar(),n.classList.remove("visible","connecting","listening","processing","speaking"))}}}showStartButton(t){if(this._globalUI){var e=this._globalUI.querySelector(".vs-start-btn");e.classList.add("visible"),e.title="not-allowed"===t?"Tap to enable microphone":"not-found"===t?"No microphone found":"not-readable"===t?"Microphone unavailable - tap to retry":"Tap to start voice assistant"}else this._pendingStartButtonReason=t}hideStartButton(){this._globalUI&&this._globalUI.querySelector(".vs-start-btn").classList.remove("visible")}showBlurOverlay(){this._globalUI&&this._card.config.background_blur&&this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible")}hideBlurOverlay(){this._globalUI&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible")}showErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("connecting","listening","processing","speaking"),t.classList.add("visible","error-mode"),t.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222)",t.style.backgroundSize="200% 100%"}}clearErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("error-mode"),t.style.background=o(this._card.config.bar_gradient),t.style.backgroundSize="200% 100%"}}hideBar(){this._globalUI&&this._globalUI.querySelector(".vs-rainbow-bar").classList.remove("visible")}_injectGlobalStyles(){if(!document.getElementById("voice-satellite-styles")){var t=document.createElement("style");t.id="voice-satellite-styles",t.textContent="/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}",document.head.appendChild(t)}}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}class u{constructor(t){this._card=t,this._log=t.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(t){this._streamEl=t}get streamedResponse(){return this._streamedResponse}set streamedResponse(t){this._streamedResponse=t}showTranscription(t){this._card.config.show_transcription&&this.addUser(t)}hideTranscription(){}showResponse(t){this._card.config.show_response&&(this._streamEl?this._streamEl.textContent=t:this.addAssistant(t))}updateResponse(t){this._card.config.show_response&&(this._streamEl?this._updateAssistant(t):this.addAssistant(t))}hideResponse(){}addUser(t){var e=this._card.ui.element;if(e){var i=this._card.config,r=e.querySelector(".vs-chat-container");r.classList.add("visible");var n=document.createElement("div");n.className="vs-chat-msg user",n.textContent=t,n.style.fontSize=i.transcription_font_size+"px",n.style.fontFamily=i.transcription_font_family,n.style.color=i.transcription_font_color,n.style.fontWeight=i.transcription_font_bold?"bold":"normal",n.style.fontStyle=i.transcription_font_italic?"italic":"normal",n.style.background=i.transcription_background,n.style.border="3px solid "+i.transcription_border_color,n.style.padding=i.transcription_padding+"px",n.style.borderRadius=i.transcription_rounded?"12px":"0",r.appendChild(n)}}addAssistant(t){var e=this._card.ui.element;if(e){var i=this._card.config,r=e.querySelector(".vs-chat-container");r.classList.add("visible");var n=document.createElement("div");n.className="vs-chat-msg assistant",n.textContent=t,n.style.fontSize=i.response_font_size+"px",n.style.fontFamily=i.response_font_family,n.style.color=i.response_font_color,n.style.fontWeight=i.response_font_bold?"bold":"normal",n.style.fontStyle=i.response_font_italic?"italic":"normal",n.style.background=i.response_background,n.style.border="3px solid "+i.response_border_color,n.style.padding=i.response_padding+"px",n.style.borderRadius=i.response_rounded?"12px":"0",r.appendChild(n),this._streamEl=n}}clear(){var t=this._card.ui.element;if(t){for(var e=t.querySelector(".vs-chat-container");e.firstChild;)e.removeChild(e.firstChild);e.classList.remove("visible"),this._streamEl=null,this._streamedResponse=""}}_updateAssistant(t){if(this._streamEl)if(t.length<=24)this._streamEl.textContent=t;else{for(var e=t.slice(0,t.length-24),i=t.slice(t.length-24),r=this._escapeHtml(e),n=0;n<i.length;n++)r+='<span style="opacity:'+((24-n)/24).toFixed(2)+'">'+this._escapeHtml(i[n])+"</span>";this._streamEl.innerHTML=r}}_escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}class h{constructor(t){this._card=t,this._log=t.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){var s=this;this._handler=function(o){if(s._card.config.double_tap_cancel&&(-1!==[e,i,r,n].indexOf(s._card.currentState)||s._card.tts.isPlaying)&&("click"!==o.type||!s._lastTapWasTouch)){s._lastTapWasTouch="touchstart"===o.type;var a=Date.now(),l=a-s._lastTapTime;if(s._lastTapTime=a,l<400&&l>0){s._log.log("ui","Double-tap detected — cancelling interaction"),o.preventDefault(),s._card.tts.isPlaying&&s._card.tts.stop(),s._card.pipeline.clearContinueState(),s._card.setState(t),s._card.chat.clear(),s._card.ui.hideBlurOverlay(),s._card.updateInteractionState("IDLE");var c=s._card.config.tts_target&&"browser"!==s._card.config.tts_target;s._card.config.chime_on_request_sent&&!c&&s._card.tts.playChime("done"),s._card.pipeline.restart(0)}}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}class p{constructor(t){this._card=t,this._log=t.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){var t=this;this._handler=function(){t._handleChange()},document.addEventListener("visibilitychange",this._handler)}_handleChange(){var t=this;this._debounceTimer&&clearTimeout(this._debounceTimer),document.hidden?(this._isPaused=!0,-1!==[e,i,r,n].indexOf(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(function(){t._log.log("visibility","Tab hidden — pausing mic"),t._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume())}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}_resume(){if(this._isPaused){this._isPaused=!1,this._card.audio.resume();var t=this._card.audio,e=this._card.pipeline;!t.isStreaming&&e.isStreaming&&t.startSending(function(){return e.binaryHandlerId}),e.resetForResume(),this._log.log("visibility","Resuming — restarting pipeline"),e.restart(0)}}}function g(t){for(var e=t,i=0;e&&i<30;){var r=e.tagName?e.tagName.toLowerCase():"";if("hui-card-preview"===r||"hui-card-edit-mode"===r||"hui-dialog-edit-card"===r||"dialog-edit-card"===r)return!0;if(e.parentElement)e=e.parentElement;else{if(!e.getRootNode||e.getRootNode()===e)break;e=e.getRootNode().host}i++}return!1}function m(t,e){var i=e,r=o(i.bar_gradient),n="top"===i.bar_position?"top: 0;":"bottom: 0;",s=i.background_blur?"backdrop-filter: blur("+i.background_blur_intensity+"px); -webkit-backdrop-filter: blur("+i.background_blur_intensity+"px); background: rgba(0,0,0,0.3);":"",a="";i.show_transcription&&(a='<div class="preview-bubble transcription" style="font-size:'+i.transcription_font_size+"px;font-family:"+i.transcription_font_family+";color:"+i.transcription_font_color+";font-weight:"+(i.transcription_font_bold?"bold":"normal")+";font-style:"+(i.transcription_font_italic?"italic":"normal")+";background:"+i.transcription_background+";border: 2px solid "+i.transcription_border_color+";padding:"+i.transcription_padding+"px;"+(i.transcription_rounded?"border-radius: 12px;":"")+"\">What's the weather like?</div>");var l="";i.show_response&&(l='<div class="preview-bubble response" style="font-size:'+i.response_font_size+"px;font-family:"+i.response_font_family+";color:"+i.response_font_color+";font-weight:"+(i.response_font_bold?"bold":"normal")+";font-style:"+(i.response_font_italic?"italic":"normal")+";background:"+i.response_background+";border: 2px solid "+i.response_border_color+";padding:"+i.response_padding+"px;"+(i.response_rounded?"border-radius: 12px;":"")+"\">It's 72°F and sunny.</div>"),t.innerHTML="<style>:host { display: block; }.preview-container {  position: relative;  width: 100%;  height: 180px;  overflow: hidden;  border-radius: var(--ha-card-border-radius, 12px);  background: var(--card-background-color, #1c1c1c);}.preview-bg {  position: absolute;  top: 0; left: 0; right: 0; bottom: 0;  background-image:    radial-gradient(circle at 20% 40%, var(--primary-color, #03a9f4) 0%, transparent 50%),    radial-gradient(circle at 75% 30%, var(--accent-color, #ff9800) 0%, transparent 40%),    radial-gradient(circle at 50% 80%, var(--info-color, #4fc3f7) 0%, transparent 45%);  opacity: 0.5;}.preview-blur {  position: absolute;  top: 0; left: 0; right: 0; bottom: 0;  "+s+"}.preview-bar {  position: absolute;  left: 0; right: 0;  "+n+"  height: "+i.bar_height+"px;  background: "+r+';  background-size: 200% 100%;  animation: preview-flow 3s linear infinite;}.preview-bubbles {  position: absolute;  left: 50%; top: 50%;  transform: translate(-50%, -50%);  display: flex;  flex-direction: column;  align-items: center;  gap: 8px;  width: 85%;}.preview-bubble {  max-width: 90%;  text-align: center;  box-shadow: 0 4px 12px rgba(0,0,0,0.15);}@keyframes preview-flow {  0% { background-position: 0% 50%; }  100% { background-position: 200% 50%; }}</style><div class="preview-container"><div class="preview-bg"></div><div class="preview-blur"></div><div class="preview-bubbles">'+a+l+'</div><div class="preview-bar"></div></div>'}class b extends HTMLElement{constructor(){super(),this._state=t,this._config=Object.assign({},s),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new a,this._audio=new l(this),this._tts=new c(this),this._pipeline=new d(this),this._ui=new _(this),this._chat=new u(this),this._doubleTap=new h(this),this._visibility=new p(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get config(){return this._config}get currentState(){return this._state}get connection(){return!this._connection&&this._hass&&this._hass.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render();var t=this;requestAnimationFrame(function(){g(t)&&t.shadowRoot?m(t.shadowRoot,t._config):(t._ui.ensureGlobalUI(),t._visibility.setup(),!window._voiceSatelliteActive&&t._hass&&t._hass.connection&&t._startListening())})}disconnectedCallback(){this._disconnectTimeout=setTimeout(function(){window._voiceSatelliteInstance},100)}setConfig(t){this._config=Object.assign({},s,t),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),this.shadowRoot&&g(this)&&m(this.shadowRoot,this._config),window._voiceSatelliteInstance&&window._voiceSatelliteInstance!==this&&(window._voiceSatelliteInstance._config=this._config,window._voiceSatelliteInstance._logger.debug=this._config.debug,window._voiceSatelliteInstance._ui.element&&window._voiceSatelliteInstance._ui.applyStyles())}set hass(t){this._hass=t,this._hasStarted||t&&t.connection&&(window._voiceSatelliteStarting||window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this||(this._connection=t.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,this._startListening()):(this._hasStarted=!0,this._ui.showStartButton())))}getCardSize(){return 0}static getConfigForm(){return{schema:[{name:"pipeline_id",selector:{assist_pipeline:{}}},{name:"start_listening_on_load",selector:{boolean:{}}},{name:"wake_word_switch",selector:{entity:{filter:[{domain:"switch"},{domain:"input_boolean"}]}}},{name:"state_entity",selector:{entity:{filter:{domain:"input_text"}}}},{name:"continue_conversation",selector:{boolean:{}}},{name:"double_tap_cancel",selector:{boolean:{}}},{name:"debug",selector:{boolean:{}}},{type:"expandable",name:"",title:"Volume & Chimes",flatten:!0,schema:[{name:"tts_target",selector:{entity:{filter:{domain:"media_player"}}}},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}},{name:"tts_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_on_wake_word",selector:{boolean:{}}},{name:"chime_on_request_sent",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Timeouts",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"pipeline_timeout",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}},{name:"pipeline_idle_timeout",selector:{number:{min:0,max:3600,step:1,unit_of_measurement:"s",mode:"box"}}}]}]},{type:"expandable",name:"",title:"Activity Bar",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"bar_position",selector:{select:{options:[{value:"bottom",label:"Bottom"},{value:"top",label:"Top"}],mode:"dropdown"}}},{name:"bar_height",selector:{number:{min:2,max:40,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{name:"bar_gradient",selector:{text:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"background_blur",selector:{boolean:{}}},{name:"background_blur_intensity",selector:{number:{min:0,max:20,step:1,mode:"slider"}}}]}]},{type:"expandable",name:"",title:"Transcription Bubble",flatten:!0,schema:[{name:"show_transcription",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"transcription_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_color",selector:{text:{}}},{name:"transcription_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_bold",selector:{boolean:{}}},{name:"transcription_font_italic",selector:{boolean:{}}},{name:"transcription_rounded",selector:{boolean:{}}}]},{name:"transcription_border_color",selector:{text:{}}},{name:"transcription_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{type:"expandable",name:"",title:"Response Bubble",flatten:!0,schema:[{name:"show_response",selector:{boolean:{}}},{name:"streaming_response",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"response_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_color",selector:{text:{}}},{name:"response_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_bold",selector:{boolean:{}}},{name:"response_font_italic",selector:{boolean:{}}},{name:"response_rounded",selector:{boolean:{}}}]},{name:"response_border_color",selector:{text:{}}},{name:"response_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]}],computeLabel:function(t){return{pipeline_id:"Assist Pipeline",start_listening_on_load:"Start listening on load",wake_word_switch:"Wake word switch entity",state_entity:"State tracking entity",continue_conversation:"Continue conversation mode",double_tap_cancel:"Double-tap to cancel interaction",debug:"Debug logging",tts_target:"TTS output device",chime_volume:"Chime volume",tts_volume:"TTS volume",chime_on_wake_word:"Chime on wake word",chime_on_request_sent:"Chime on request sent",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)",pipeline_timeout:"Pipeline timeout",pipeline_idle_timeout:"Idle restart timeout",bar_position:"Bar position",bar_height:"Bar height",bar_gradient:"Gradient colors",background_blur:"Background blur",background_blur_intensity:"Blur intensity",show_transcription:"Show transcription",transcription_font_size:"Font size",transcription_font_family:"Font family",transcription_font_color:"Font color",transcription_background:"Background color",transcription_font_bold:"Bold",transcription_font_italic:"Italic",transcription_rounded:"Rounded corners",transcription_border_color:"Border color",transcription_padding:"Padding",show_response:"Show response",streaming_response:"Streaming response",response_font_size:"Font size",response_font_family:"Font family",response_font_color:"Font color",response_background:"Background color",response_font_bold:"Bold",response_font_italic:"Italic",response_rounded:"Rounded corners",response_border_color:"Border color",response_padding:"Padding"}[t.name]||void 0},computeHelper:function(t){return{wake_word_switch:"Turn OFF this switch when wake word is detected (e.g., Fully Kiosk screensaver)",state_entity:"Updates with ACTIVE/IDLE for per-device automations",tts_target:"Leave empty for browser audio, or select a media player entity",pipeline_timeout:"Max seconds to wait for pipeline response (0 = no timeout)",pipeline_idle_timeout:"Seconds before pipeline restarts to keep connection fresh",bar_gradient:"Comma-separated CSS color values",voice_isolation:"AI-based voice isolation, currently only available in Chrome",transcription_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",transcription_border_color:"CSS color value (supports rgba)",response_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",response_border_color:"CSS color value (supports rgba)"}[t.name]||void 0}}}static getStubConfig(){return{start_listening_on_load:!0}}setState(t){var i=this._state;this._state=t,this._logger.log("state",i+" → "+t),this._ui.updateForState(t,this._pipeline.serviceUnavailable,this._tts.isPlaying),t===e&&this.updateInteractionState("ACTIVE")}updateInteractionState(t){var e=this._config.state_entity;if(e&&this._hass){var i=this;this._logger.log("state_entity",e+" → "+t),this._hass.callService("input_text","set_value",{entity_id:e,value:t}).catch(function(t){i._logger.error("state_entity","Failed to update "+e+": "+t)})}}onStartClick(){this._handleStartClick()}onPipelineMessage(t){this._handlePipelineMessage(t)}onTTSComplete(){if(-1===[e,i,r,n].indexOf(this._state)){if(this._pipeline.shouldContinue&&this._pipeline.continueConversationId){this._logger.log("pipeline","Continuing conversation — skipping wake word");var t=this._pipeline.continueConversationId;return this._pipeline.clearContinueState(),this._chat.streamEl=null,void this._pipeline.restartContinue(t)}var s=this._config.tts_target&&"browser"!==this._config.tts_target;this._config.chime_on_request_sent&&!s&&this._tts.playChime("done"),this._chat.clear(),this._ui.hideBlurOverlay(),this._ui.updateForState(this._state,this._pipeline.serviceUnavailable,!1),this.updateInteractionState("IDLE")}else this._logger.log("tts","New interaction in progress — skipping cleanup")}turnOffWakeWordSwitch(){if(this._config.wake_word_switch&&this._hass){var t=this,e=this._config.wake_word_switch;e.includes(".")?(this._logger.log("switch","Turning off: "+e),this._hass.callService("homeassistant","turn_off",{entity_id:e}).catch(function(e){t._logger.error("switch","Failed to turn off: "+e)})):this._logger.log("switch","Invalid entity: "+e)}}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),g(this)?m(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}async _startListening(){if(window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this)this._logger.log("lifecycle","Another instance is active, skipping");else if(window._voiceSatelliteStarting)this._logger.log("lifecycle","Pipeline already starting globally, skipping");else{window._voiceSatelliteStarting=!0;try{this.setState("CONNECTING"),await this._audio.startMicrophone(),await this._pipeline.start(),window._voiceSatelliteActive=!0,window._voiceSatelliteInstance=this,this._ui.hideStartButton(),this._doubleTap.setup()}catch(i){this._logger.error("pipeline","Failed to start: "+i);var e="error";"NotAllowedError"===i.name?(e="not-allowed",this._logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===i.name?(e="not-found",this._logger.error("mic","No microphone found")):"NotReadableError"!==i.name&&"AbortError"!==i.name||(e="not-readable",this._logger.error("mic","Microphone in use or not readable")),this._ui.showStartButton(e),this.setState(t)}finally{window._voiceSatelliteStarting=!1}}}async _handleStartClick(){await this._audio.ensureAudioContextForGesture(),await this._startListening()}_handlePipelineMessage(t){if(this._visibility.isPaused)this._logger.log("event","Ignoring event while paused: "+t.type);else if(this._pipeline.isRestarting)this._logger.log("event","Ignoring event while restarting: "+t.type);else{var e=t.type,s=t.data||{};if(this._config.debug){var o=t.timestamp?t.timestamp.split("T")[1].split(".")[0]:"";this._logger.log("event",o+" "+e+" "+JSON.stringify(s).substring(0,500))}switch(e){case"run-start":this._pipeline.handleRunStart(s);break;case"wake_word-start":this._pipeline.handleWakeWordStart();break;case"wake_word-end":this._pipeline.handleWakeWordEnd(s);break;case"stt-start":this.setState(i);break;case"stt-vad-start":this._logger.log("event","VAD: speech started");break;case"stt-vad-end":this._logger.log("event","VAD: speech ended");break;case"stt-end":this._pipeline.handleSttEnd(s);break;case"intent-start":this.setState(r);break;case"intent-progress":this._config.streaming_response&&this._pipeline.handleIntentProgress(s);break;case"intent-end":this._pipeline.handleIntentEnd(s);break;case"tts-start":this.setState(n);break;case"tts-end":this._pipeline.handleTtsEnd(s);break;case"run-end":this._pipeline.handleRunEnd();break;case"error":this._pipeline.handleError(s)}}}}customElements.define("voice-satellite-card",b),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v2.9.0 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();